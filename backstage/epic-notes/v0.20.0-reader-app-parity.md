# v0.20.0 - Parity with Reader Apps (Kavita/Komga Integration)

**Epic:** [v0.20.0 Parity with Reader Apps](../ROADMAP.md#v0200)

**Status:** ðŸ’¡ PROPOSED (2026-02-21)

---

## Goal

**Deep integration with reader apps for granular citations and seamless reading workflow.**

**Problem:**
- Librarian citations stop at book level (`Graeber - Debt, the First 5000 Years.epub`)
- Citations don't include: chapter, page, paragraph
- Can't jump directly to cited passage in reader app
- **Current workflow:** Search â†’ find result â†’ manually open book â†’ manually hunt for page/paragraph

**Ideal workflow:**
1. Librarian search: `research --topic "debt vs gift economies"`
2. Result citation: `Graeber - Debt > Chapter 2 > Page 42 > Para 3` + **[Open in Kavita]**
3. Click link â†’ Kavita opens on **exact page 42**
4. User reads full context immediately (no manual hunting)

---

## Reader Apps to Support

### Kavita
- **URL:** https://www.kavitareader.com/
- **Focus:** Comics, manga, but supports EPUB/PDF
- **API:** REST API available
- **Deep-link research needed:** Can we pass `?page=42` to open on specific page?

### Komga
- **URL:** https://komga.org/
- **Focus:** Comics, BD (CBZ/CBR primary)
- **API:** REST API available
- **Deep-link research needed:** URL params for page navigation?

### Calibre-web
- **URL:** https://github.com/janeczku/calibre-web
- **Focus:** General ebook management
- **API:** Limited (mostly web UI)
- **Deep-link research needed:** Can we link to specific chapter/page?

### Audiobookshelf
- **URL:** https://www.audiobookshelf.org/
- **Focus:** Audiobooks, podcasts (not text-based)
- **Relevance:** Low for Librarian (text search only)

### Who else?
- **Readarr?** (acquisition, not reading)
- **Ubooquity?** (simple web reader, limited API)
- **Others?** (TBD)

---

## Granular Citation Challenge

### EPUB Pagination Problem
**EPUBs don't have fixed pages** (reflow text based on font size, device).

**Options:**
1. **Chapter + Paragraph** - Stable, works across devices
   - Citation: `Book > Chapter 2 > Para 3`
   - Deep-link: `kavita.com/reader?book=123&chapter=2` (if API supports)
   - User still manually finds paragraph (better than nothing)

2. **Anchor IDs** - EPUB internal links
   - Citation: `Book > Chapter 2 > #anchor-42`
   - Deep-link: `kavita.com/reader?book=123#anchor-42`
   - **Requires:** EPUB has anchor IDs, reader app honors them

3. **Estimated Page** - Convert character offset â†’ approximate page
   - Citation: `Book > ~Page 42 (approx)`
   - Deep-link: `kavita.com/reader?book=123&page=42`
   - **Problem:** Approximation, breaks on font size changes

**Recommended:** Start with **Chapter + Paragraph** (most stable).

### PDF Pagination (Easy)
**PDFs have native page numbers.**

**Citation:** `Book.pdf > Page 42 > Para 3`

**Deep-link:** `kavita.com/reader?book=123&page=42` (if API supports)

### CBZ/CBR (Comic Books)
**Image sequence = page numbers straightforward.**

**Citation:** `Comic.cbz > Page 15`

**Deep-link:** `komga.com/reader?book=123&page=15`

---

## Tasks

### Phase 1: Research
- [ ] Kavita API documentation (reader endpoints, page params)
- [ ] Komga API documentation (same)
- [ ] Calibre-web capabilities (can it deep-link?)
- [ ] Test existing reader apps (which support page-level URLs?)

### Phase 2: Granular Indexing
- [ ] Extract paragraph-level metadata during indexing
- [ ] Store: `{book, chapter, paragraph_index, text}`
- [ ] For PDFs: also store native page numbers
- [ ] For EPUBs: store chapter + paragraph (no fixed pages)

### Phase 3: Citation Format
- [ ] Update research.py output:
   ```
   Book: Graeber - Debt, the First 5000 Years.epub
   Chapter: 2 - The Myth of Barter
   Paragraph: 3
   URL: http://kavita.local/reader?book=debt&chapter=2&para=3
   ```
- [ ] If reader app supports deep-link â†’ include URL
- [ ] If not â†’ show book + chapter + para (manual navigation)

### Phase 4: Reader App Integration
- [ ] Kavita setup (API token, base URL)
- [ ] Generate deep-links (map librarian metadata â†’ reader URL)
- [ ] Test: Click citation â†’ reader opens on correct page
- [ ] Fallback: If API doesn't support page-level â†’ open book, show page number in citation

### Phase 5: Documentation
- [ ] How to connect Librarian â†’ Kavita/Komga
- [ ] Supported formats (EPUB, PDF, CBZ)
- [ ] Limitations (EPUB pagination approximate, reader app must support deep-links)

---

## Success Criteria

- âœ… Citations include: Book, Chapter, Page (or Para), Paragraph
- âœ… Click citation â†’ reader app opens on exact page (when supported)
- âœ… Works for:
  - PDF (exact page)
  - CBZ/CBR (exact page)
  - EPUB (best effort: chapter + para)
- âœ… Documented setup (how to configure reader app integration)
- âœ… Documented limitations (EPUB pagination challenges)

---

## Dependencies

- **v0.16.0 Unified Indexing** - Metadata pipeline must support granular refs (chapter, para)
- **v0.19.0 Multi-Format Support** - PDF/EPUB extraction enhancements

---

## Future Enhancements

- **Audio sync:** If audiobook exists, jump to timestamp (Audiobookshelf integration)
- **Highlight sync:** Save highlighted passages from reader app â†’ index in Librarian
- **Bidirectional:** Reader app â†’ search Librarian from highlighted text

---

**Created:** 2026-02-21  
**Updated:** 2026-02-21
