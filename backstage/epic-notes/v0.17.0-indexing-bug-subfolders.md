# v0.17.0 - Indexing Bug: Subfolders Not Discovered

**Epic:** Multi-Scope Queries (v0.17.0)  
**Date discovered:** 2026-02-10  
**Reporter:** Nicholas + Claw

---

## ğŸš¨ Bug Description

**~50+ subfolders with books are NOT being indexed!**

**Examples of missing content:**
- `theory/system/` (DeLanda - Philosophy and Simulation)
- `magick/tarot/`, `magick/chaos/`, `magick/i ching/`, `magick/familiars/`
- `anarchy/hakim bey/`, `anarchy/james c scott/`, `anarchy/david graeber/`
- `design/usability/`, `design/typography/`, `design/generative/`
- `drawing/basics/`, `drawing/portrait/`, `drawing/clothes/`
- `finances/debt/`, `finances/taxes/`, `finances/mortgage/`
- `AI/theory/`, `AI/policy/`, `AI/prompt engineering/`
- And ~40+ more...

**Impact:** **Metade da biblioteca ou mais** nÃ£o tÃ¡ acessÃ­vel via research!

---

## ğŸ” Root Cause

**File:** `~/Documents/librarian/engine/scripts/index_library.py`  
**Function:** `scan_library_folders()` (lines 250-285)

**Problem:** 
```python
has_books = any(
    f.suffix.lower() in ['.epub', '.pdf']
    for f in item.iterdir()
    if f.is_file()
)
```

**Logic checks ONLY immediate folder for books**, nÃ£o registra subfolders como topics independentes.

**Current behavior:**
- âœ… `books/theory/` (tem livros diretamente) â†’ registra como topic
- âŒ `books/theory/system/` (tem livros, mas Ã© subfolder) â†’ **NÃƒO registra**

**Recursion EXISTS** (`scan_directory()` se chama recursivamente), **MAS** sÃ³ adiciona ao registry se `has_books` = True no nÃ­vel atual.

**Result:** 
- `registry['topics']` sÃ³ tem pastas com livros diretamente
- `--all` indexa tudo no registry â†’ subfolders ficam de fora

---

## ğŸ“ Architecture Rule (Nicholas)

**NEVER:** Pasta com livros + subfolders ao mesmo tempo

**ALWAYS:** Topic folder OU tem subfolders OU tem livros (nunca ambos)

**Examples:**
- âœ… `theory/` â†’ sem livros, sÃ³ subfolders (`system/`, `anthropocene/`, etc.)
- âœ… `theory/system/` â†’ TEM livros (Philosophy and Simulation, etc.)
- âŒ `theory/` â†’ livros + subfolders (violates rule)

**Current structure already follows this!** Bug is in discovery logic not respecting it.

---

## âœ… Solution

**Fix `scan_library_folders()` to:**

1. **Scan recursively** (already does this âœ…)
2. **Register ANY folder with books as independent topic** (currently broken âŒ)
3. **Ignore empty folders** (already does this âœ…)

**Pseudocode:**
```python
def scan_directory(base_path, relative_path=""):
    for item in base_path.iterdir():
        if item.is_dir():
            # Check if THIS folder has books
            has_books = any(f.suffix in ['.epub', '.pdf'] for f in item.iterdir() if f.is_file())
            
            if has_books:
                # Register as topic
                topic_id = slugify(relative_path + "/" + item.name)
                topics.append({'id': topic_id, 'path': relative_path + "/" + item.name})
            
            # ALWAYS recurse into subfolders (even if current has books)
            scan_directory(item, relative_path + "/" + item.name)
```

**Key change:** Don't skip recursion when `has_books = True`. Check each folder independently.

---

## ğŸ§ª Test Cases

**After fix, verify:**

1. **Existing topics still work:**
   - `theory/` â†’ no books, has subfolders â†’ NOT a topic âœ…
   - `cooking/` â†’ has books directly â†’ IS a topic âœ…

2. **Subfolders discovered:**
   - `theory/system/` â†’ has books â†’ IS a topic âœ…
   - `magick/tarot/` â†’ has books â†’ IS a topic âœ…

3. **Empty folders ignored:**
   - `design/unused/` â†’ no books â†’ NOT a topic âœ…

4. **Deep nesting works:**
   - `design/usability/rosenfeld/` â†’ has books â†’ IS a topic âœ…
   - `design/usability/general/` â†’ has books â†’ IS a topic âœ…

5. **Run `--all` reindexes everything:**
   ```bash
   cd ~/Documents/librarian/engine/scripts
   python3 index_library.py --all
   ```

6. **Verify topic count:**
   ```bash
   cat ~/Documents/librarian/books/.library-index.json | jq '.topics | length'
   ```
   **Expected:** ~70+ topics (currently ~20)

---

## ğŸ“Š Validation

**Before fix:**
```bash
# Count current topics
cat ~/Documents/librarian/books/.library-index.json | jq '.topics | length'
# Output: ~20
```

**After fix:**
```bash
# Reindex
python3 index_library.py --all

# Count new topics
cat ~/Documents/librarian/books/.library-index.json | jq '.topics | length'
# Expected: ~70+

# Verify DeLanda findable
python3 research-tracked.sh "Philosophy and Simulation DeLanda"
# Should find: theory/system/Philosophy and Simulation.epub
```

---

## ğŸš§ Implementation Notes

**File to edit:** `~/Documents/librarian/engine/scripts/index_library.py`

**Function:** `scan_library_folders()` (lines 250-285)

**Keep:**
- Recursive scanning âœ…
- Slugify logic âœ…
- Skip hidden files/system files âœ…

**Fix:**
- Register ALL folders with books (not just top-level)
- Don't skip recursion when folder has books

**After fix:**
- Run full reindex (`--all`)
- Test multi-topic search (v0.17.0 epic goal)
- Update topic count in docs

---

## ğŸ”— Related

**Epic:** v0.17.0 - Multi-Scope Queries  
**Blocked by:** This bug (can't test multi-topic if half the topics don't exist)  
**Priority:** HIGH (blocks v0.17.0 + breaks current research for ~50% of library)

---

**Next:** Fix â†’ test â†’ validate â†’ merge â†’ celebrate ğŸ´
