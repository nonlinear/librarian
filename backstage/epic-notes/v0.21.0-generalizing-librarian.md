# v0.21.0 - Generalizing Librarian (Skill Portability)

**Created:** 2026-02-21  
**Status:** üìã PROPOSED

**Make librarian skill portable and self-contained**

---

## Context (v0.15.0 Changes)

**research.py now lives in skill/ folder:**
- ‚úÖ `skill/research.py` included (21KB)
- ‚úÖ Smart path detection (works standalone OR with parent)
- ‚úÖ `skill/setup.sh` downloads model + installs deps
- ‚úÖ `skill/requirements.txt` lists Python dependencies

**What this means for v0.21.0:**
- research.py already portable ‚úÖ
- Model download already automated (setup.sh) ‚úÖ
- **Still need:** Onboarding (where are books?), embedded indexing, multi-instance config

**Skill structure (v0.15.0):**
```
skill/
‚îú‚îÄ‚îÄ research.py          ‚Üê Search engine (standalone)
‚îú‚îÄ‚îÄ librarian.sh         ‚Üê Wrapper (smart paths)
‚îú‚îÄ‚îÄ setup.sh             ‚Üê Model download + deps
‚îú‚îÄ‚îÄ requirements.txt     ‚Üê Python deps
‚îú‚îÄ‚îÄ books/ (symlink)     ‚Üê User books (or parent)
‚îî‚îÄ‚îÄ models/ (gitignored) ‚Üê Downloaded on setup
```

---

## Problem

**Current state:**
- Skill assumes hardcoded paths (`~/Documents/librarian/skill/`)
- No onboarding process (user must know where to put files)
- Indexing separate from skill (manual `index_library.py`)
- Every user's setup is bespoke (no standardization)

**Pain points:**
- Hard to share skill with others
- Hard to move to different machine
- Hard to manage multiple instances (work vs personal library)
- Configuration scattered (no single source of truth)

---

## Solution

**Make skill self-aware and interactive:**

1. **Onboarding:** `setup librarian` - guided configuration
2. **Embedded indexing:** `update librarian` - skill manages own indexes
3. **Per-instance variables:** Support multiple libraries with different configs

---

## Tasks

### 1. Onboarding Skill ("setup librarian")

**Goal:** Interactive setup asking where things are, how they should be configured

**Flow:**
```
User: "setup librarian"
Skill: "Where are your books?"
User: "~/Documents/books"
Skill: "Where should I store indexes?"
User: "~/Documents/librarian/indexes"
Skill: "Which embedding model? (bge-small-en-v1.5, all-MiniLM-L6-v2)"
User: "bge-small-en-v1.5"
Skill: "‚úÖ Config saved. Run 'update librarian' to index."
```

**Implementation:**
- [ ] Create `setup.sh` script (interactive prompts)
- [ ] Generate `.librarian-config.json` (per-instance config)
- [ ] Store config location (global vs per-skill-instance)
- [ ] Validate paths (books exist, writable indexes folder)
- [ ] Handle edge cases (config exists, overwrite?)

**Config format:**
```json
{
  "schema_version": "1.0",
  "books_path": "~/Documents/books",
  "indexes_path": "~/Documents/librarian/indexes",
  "embedding_model": "bge-small-en-v1.5",
  "chunk_size": 1024,
  "chunk_overlap": 200
}
```

---

### 2. Embed Indexing on Skill ("update librarian")

**Goal:** Skill manages indexing without external commands

**Flow:**
```
User: "update librarian"
Skill: 
  - Reads config
  - Scans books_path for new/changed files
  - Runs indexing (smart mode)
  - Updates metadata
  - Reports: "‚úÖ Indexed 5 new books, updated 2 topics"
```

**Implementation:**
- [ ] Wrap `index_library.py` logic in skill
- [ ] Add smart detection (only index changed files)
- [ ] Progress feedback (user sees what's happening)
- [ ] Handle errors gracefully (book corrupt, model missing)
- [ ] Update `.library-index.json` after indexing

**Commands:**
- `update librarian` - smart update (new/changed only)
- `update librarian --full` - reindex everything
- `update librarian --topic magick_chaos` - reindex specific topic

---

### 3. Per-Skill Instance Variables

**Goal:** Support multiple librarian instances (work, personal, research)

---

### 4. Answer Syntax Enhancement

**Goal:** Improve librarian response format with numbered points + source links

**Current format (v0.15.0):**
```markdown
> [S√≠ntese] üìï [Book, p.21, ¬∂2]
>
> [Mais detalhes] üìï [Book, p.40, ¬∂5]
>
> **Sources:**
> - üìï Book Title (Author) - X passages
> - Similarity: ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê
```

**Proposed format:**
```markdown
> 1Ô∏è‚É£ [First point] üìï [Book, p.21, ¬∂2]
>
> 2Ô∏è‚É£ [Second point] üìï [Book, p.40, ¬∂5]
>
> 3Ô∏è‚É£ [Third point] üìï [Book, p.89, ¬∂1]
>
> **Sources:**
> - üìï [Book Title](file://~/Documents/books/book.epub) - 3 passages
> - Similarity: ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê
```

**Changes:**
- [ ] Add numbered emojis (1Ô∏è‚É£2Ô∏è‚É£3Ô∏è‚É£) to structure multi-point answers
- [ ] Add clickable file:// links to source books
- [ ] Update SKILL.md example output
- [ ] Test readability (does numbering help or clutter?)

**Why:**
- Easier to reference specific points in conversation ("sobre o 2Ô∏è‚É£...")
- Clickable links = jump directly to book in reader app
- Better structure for complex answers (3+ points)

**Sintaxe Atual (Real Example - 2026-02-21):**

Query: "hexagrama 22 ansiedade projeto novo compelido trabalho"

Response format used:
```markdown
üìö Hexagrama 22 - Gra√ßa (Bi):

> O Hexagrama 22 diz pra **relaxar**. Quando Conf√∫cio recebeu esse hexagrama, ficou irritado por ser avisado de que estava se levando a s√©rio demais. üìï [I Ching Made Easy, ch001_split_000.xhtml, ¬∂1120]
>
> **Sobre projetos novos:** A perspectiva nova foi o conselho espec√≠fico... üìï [I Ching Made Easy, ch001_split_000.xhtml, ¬∂1047]
>
> **Sobre entusiasmo e mod√©stia:** "Quando algu√©m possui algo grande e √© modesto, certamente haver√° entusiasmo." üìï [The I Ching or Book of Changes, pup-iching097.html, ¬∂6]

**S√≠ntese:** [Interpreta√ß√£o integrada]

**Sources:**
- üìï I Ching Made Easy (Amy M. Sorrell) - 2 passagens
- üìï The I Ching or Book of Changes (Richard Wilhelm) - 1 passagem
- Similarity: ‚≠ê‚≠ê‚≠ê (0.49, relevante mas n√£o perfeito match)
```

**What works:**
- ‚úÖ Blockquote (>) cleanly separates oracle response from synthesis
- ‚úÖ **Bold subheadings** structure multi-topic answers
- ‚úÖ Inline üìï citations feel natural (not intrusive)
- ‚úÖ Sources section = quick reference
- ‚úÖ Similarity score with context (0.49 = relevant but not perfect)

**What could improve:**
- Numbers (1Ô∏è‚É£2Ô∏è‚É£3Ô∏è‚É£) might help reference specific points later
- file:// links would allow jumping directly to source
- Location format varies (ch001_split_000.xhtml vs p.21) - normalize?

**Open questions:**
- Always use numbers, or only when 3+ points?
- file:// links work on all platforms? (macOS, Linux, webchat)
- Should numbers match result order from research.py?
- Keep **bold subheadings** or replace with numbers?

**Note (2026-02-21):** --book search quebrado (returned 0 results), had to use --topic instead. Bug or indexing issue?

---

**Use case:**
- Work library: `~/Work/library` (tech books, project docs)
- Personal library: `~/Documents/books` (fiction, magick, theory)
- Research library: `~/Research/papers` (academic papers)

**Proposal A: Environment variables**
```bash
LIBRARIAN_CONFIG=~/Work/.librarian-config.json
```

**Proposal B: Named instances**
```bash
# Setup instances
setup librarian --instance work --books ~/Work/library
setup librarian --instance personal --books ~/Documents/books

# Use instance
research for X --instance work
```

**Proposal C: Config paths**
```bash
# Skill looks for config in order:
1. ./.librarian-config.json (current dir)
2. ~/.librarian-config.json (home dir)
3. ~/Documents/librarian/.librarian-config.json (default)
```

**Tasks:**
- [ ] **DECIDE:** Which approach? (env vars vs named instances vs path-based)
- [ ] Implement instance selection logic
- [ ] Update wrapper to pass config path
- [ ] Test multiple instances (no conflicts)
- [ ] Document multi-instance workflow

**Open question:** How does user specify which instance during query?

---

## Success Criteria

**Onboarding:**
- ‚úÖ New user runs `setup librarian`, answers questions, gets working config
- ‚úÖ Config validation catches errors (missing paths, invalid models)
- ‚úÖ Can reconfigure without breaking existing indexes

**Embedded indexing:**
- ‚úÖ `update librarian` indexes new books automatically
- ‚úÖ Smart detection (only changed files)
- ‚úÖ User sees progress (not black box)
- ‚úÖ Errors handled gracefully (corrupt book = skip, report)

**Per-instance variables:**
- ‚úÖ Can run multiple libraries on same machine
- ‚úÖ No conflicts between instances
- ‚úÖ Clear which instance is active
- ‚úÖ Easy to switch instances

---

## Dependencies

**Blocks:**
- None (can implement alongside other epics)

**Blocked by:**
- v0.15.0 complete (skill protocol stable)
- v0.16.0 preferred (unified indexing helps)

---

## Design Questions

**1. Where to store config?**
- Global (`~/.librarian-config.json`) vs per-instance?
- How to discover config location?

**2. How to handle multiple instances?**
- Env vars, named instances, or path-based?
- User UX: explicit instance selection vs auto-detection?

**3. Skill vs wrapper responsibility?**
- Should skill run indexing directly or call wrapper?
- Error handling: skill layer or wrapper layer?

**4. Backward compatibility?**
- Current hardcoded paths = breaking change?
- Migration path for existing users?

---

## Future Enhancements (v0.22.0+)

**Auto-update triggers:**
- Watch folder for new books ‚Üí auto-index
- Cron job ‚Üí daily smart update
- Pre-query check ‚Üí index stale? update first

**Cloud sync:**
- Config synced across machines (iCloud, Dropbox)
- Indexes portable (or regenerate on new machine)

**Shared configs:**
- Team library (same config, different users)
- Read-only vs read-write access

---

**Next steps:**
1. Design config schema (onboarding questions ‚Üí JSON)
2. Prototype `setup.sh` (interactive flow)
3. Decide instance selection approach
4. Implement embedded indexing wrapper
5. Test multi-instance workflow

---

## Architecture Question (2026-02-21 - PENSAR)

**Problema:** Skill com research.py inclu√≠do = pesado (torch 500MB+, models 130MB+)

**Op√ß√£o A: Skill leve (companion only)**
- SKILL.md + wrappers (4 arquivos, <50KB)
- Depende de parent librarian (engine/)
- `clawhub install` N√ÉO funciona sozinho
- Pros: Leve, single source of truth
- Cons: Precisa parent instalado

**Op√ß√£o B: Skill pesado (standalone)**
- SKILL.md + wrappers + research.py + requirements.txt + setup.sh
- Funciona sozinho (self-contained)
- `clawhub install` funciona ‚úÖ
- Pros: Standalone, f√°cil instalar
- Cons: Duplica√ß√£o (500MB+ deps), manuten√ß√£o de 2 c√≥pias

**Status atual (v0.15.0):** Op√ß√£o B (research.py inclu√≠do)

**Decis√£o:** PENSAR v0.21.0 (deixar como est√° por enquanto)

**Teste:** ‚úÖ PASSOU (funciona com research.py no skill/)
