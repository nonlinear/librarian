# v0.19.0 - Kavita Deep Linking

**Status:** ðŸ“‹ Active  
**Created:** 2026-02-25  
**Priority:** High

---

## Problem

**Research results have no source links:**
- User gets relevant chunks from search
- Must manually find book in Kavita
- Must manually navigate to chapter/page
- Breaks flow, wastes time

**Metadata has granularity, but no links:**
- EPUB chunks: `chapter` (HTML file) + `paragraph`
- PDF chunks: `page` (number) + `paragraph`
- No way to construct Kavita URL

---

## Goal

**Click research result â†’ open Kavita at exact location**

**Requirements:**
1. Map filename â†’ Kavita seriesId (index Kavita metadata)
2. Investigate Kavita deep-linking (URL parameters)
3. Generate links in research.py output
4. Make links clickable in VS Code extension

---

## Investigation Questions

### 1. Can we map filename â†’ Kavita seriesId?

**Current metadata:**
```json
{
  "filename": "On Intelligence.epub",
  "book_id": "on_intelligence"
}
```

**Need:**
- Kavita API: list all series in library
- Map: filename â†’ seriesId
- Store in `.topic-index.json` during indexing

**Kavita API endpoint:** `/api/Library/{libraryId}/series`

**libraryId:** Fixed (only one library)

---

### 2. Does Kavita support deep-linking?

**Must test:**
- Navigate to chapter in Kavita â†’ check URL
- Navigate to page in PDF â†’ check URL
- Look for URL parameters: `#page=N`, `?chapter=X`, `#anchor`

**Hypotheses:**
- **EPUB:** Kavita might use `#chapter-name` or `#page-N`
- **PDF:** Kavita likely uses `#page=N` (standard PDF viewer pattern)
- **Worst case:** No deep-linking, link to book root

**Test plan:**
1. Open Kavita in browser
2. Navigate to chapter 5 of an EPUB
3. Copy URL
4. Test if URL with modified params opens different chapter

---

### 3. Can we construct links from metadata?

**If Kavita supports deep-linking:**

**EPUB pattern (hypothesis):**
```
http://kavita.host/library/{libraryId}/series/{seriesId}#chapter={chapter_file}
```

**PDF pattern (hypothesis):**
```
http://kavita.host/library/{libraryId}/series/{seriesId}#page={page_number}
```

**Metadata â†’ URL:**
```python
chunk = {
  "filename": "On Intelligence.epub",
  "chapter": "On_Intelligence_split_005.html",  # EPUB
  "page": 42,  # PDF
  "seriesId": 123  # NEW: from Kavita API
}

# EPUB link
url = f"http://kavita.host/library/1/series/{chunk['seriesId']}#chapter={chunk['chapter']}"

# PDF link
url = f"http://kavita.host/library/1/series/{chunk['seriesId']}#page={chunk['page']}"
```

**Fallback (no deep-linking):**
```python
url = f"http://kavita.host/library/1/series/{chunk['seriesId']}"
```

---

## Tasks

### Phase 1: Investigation
- [ ] Test Kavita deep-linking manually
  - [ ] Open EPUB, navigate chapter, copy URL
  - [ ] Open PDF, navigate page, copy URL
  - [ ] Test URL modification (change page/chapter param)
  - [ ] Document URL structure

- [ ] Research Kavita API
  - [ ] Find API docs (GitHub, wiki, or reverse-engineer)
  - [ ] Test `/api/Library/{id}/series` endpoint
  - [ ] Map filename â†’ seriesId for test book
  - [ ] Check if API provides chapter/page metadata

### Phase 2: Indexing
- [ ] Update `index_library.py` to fetch Kavita metadata
  - [ ] Call Kavita API: list all series
  - [ ] Match filename to seriesId (fuzzy match if needed)
  - [ ] Store `seriesId` in `.topic-index.json`
  - [ ] Handle missing books (not in Kavita)

- [ ] Update `.topic-index.json` schema
  ```json
  {
    "books": [
      {
        "id": "on_intelligence",
        "filename": "On Intelligence.epub",
        "kavita_series_id": 123  // NEW
      }
    ]
  }
  ```

### Phase 3: Link Generation
- [ ] Update `research.py` to generate Kavita URLs
  - [ ] Read `kavita_series_id` from metadata
  - [ ] Construct URL with deep-link (if supported)
  - [ ] Add `kavita_url` field to output
  - [ ] Test with EPUB and PDF

- [ ] Output format
  ```json
  {
    "chunk": "...",
    "book_title": "On Intelligence",
    "chapter": "On_Intelligence_split_005.html",
    "page": null,
    "kavita_url": "http://kavita.host/library/1/series/123#chapter=..."
  }
  ```

### Phase 4: VS Code Integration
- [ ] Make `kavita_url` clickable in extension
  - [ ] Render as hyperlink
  - [ ] Open in default browser
  - [ ] Tooltip: "Open in Kavita"

### Phase 5: Fallbacks & Edge Cases
- [ ] Handle books not in Kavita
  - [ ] `kavita_url: null` if no seriesId
  - [ ] Or generic search link: `http://kavita.host/search?q={book_title}`

- [ ] Handle Kavita down/unreachable
  - [ ] Don't block research if Kavita API fails
  - [ ] Log warning, continue without links

- [ ] Handle deep-linking not supported
  - [ ] Fallback to book root URL
  - [ ] Document limitation

---

## Success Criteria

- âœ… Research results include `kavita_url` field
- âœ… Click link â†’ opens Kavita at exact chapter (EPUB)
- âœ… Click link â†’ opens Kavita at exact page (PDF)
- âœ… Graceful degradation if deep-linking unsupported
- âœ… Handles books not in Kavita (null or search link)

---

## Open Questions

1. **Kavita API authentication:** Does API require token? (check Kavita settings)
2. **Filename matching:** Exact match or fuzzy? (Kavita might rename files)
3. **Multiple libraries:** Future-proof for >1 library? (hardcode libraryId=1 for now?)
4. **Chapter name format:** Does Kavita use HTML filename or chapter title?
5. **Paragraph-level linking:** Possible? (probably not, but worth checking)

---

## References

- Kavita GitHub: https://github.com/Kareadita/Kavita
- Kavita Docs: https://wiki.kavitareader.com/
- Current metadata structure: `~/Documents/librarian/books/*/.topic-index.json`
- Research script: `~/Documents/librarian/engine/scripts/research.py`
