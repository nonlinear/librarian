```mermaid
---
title: Librarian skill as protocol
---
flowchart TD
    TRIGGER(["Trigger + context"])
    TRIGGER --> METADATA(["Load metadata 1Ô∏è‚É£"])
    METADATA --> CHECK{"Metadata exists?"}
    CHECK -->|NO| ERROR(["‚ö†Ô∏è No metadata found 4Ô∏è‚É£<br/>Run librarian index"])
    CHECK -->|YES| INFER{"Infer scope? 2Ô∏è‚É£"}
    
    INFER -->|"low confidence"| CLARIFY(["Ask clarification"])
    CLARIFY --> TRIGGER
    
    INFER -->|"explicit"| BUILD(["Build command 3Ô∏è‚É£"])
    
    BUILD --> EXEC(["Run python script with flags"])
    EXEC --> JSON(["Return JSON"])
    JSON --> FORMAT(["Format output 5Ô∏è‚É£"])
    FORMAT --> USER(["Response"])
    
    style TRIGGER fill:#E0E0E0,stroke:#9E9E9E,color:#000
    style METADATA fill:#FFEB3B,stroke:#F9A825,color:#000
    style INFER fill:#FFEB3B,stroke:#F9A825,color:#000
    style CLARIFY fill:#E0E0E0,stroke:#9E9E9E,color:#000
    style BUILD fill:#FFB6C1,stroke:#D81B60,color:#000
    style EXEC fill:#E0E0E0,stroke:#9E9E9E,color:#000
    style JSON fill:#E0E0E0,stroke:#9E9E9E,color:#000
    style FORMAT fill:#FFB6C1,stroke:#D81B60,color:#000
    style USER fill:#E0E0E0,stroke:#9E9E9E,color:#000
    style CHECK fill:#FFEB3B,stroke:#F9A825,color:#000
    style ERROR fill:#FFB6C1,stroke:#D81B60,color:#000
```

---

# Librarian Architecture

**Epic:** v0.15.0 ‚Äî Skill Enforcement  
**Status:** üü® Design Phase  
**Date:** 2026-02-08

---

## Notes

### 1Ô∏è‚É£ Load Metadata (needs discussion)

**Current behavior:**
- Reads `.librarian-index.json` (global metadata)
- Reads multiple `.topic-index.json` files (per-topic embeddings)

**Question:** Should metadata loading be:
- **Explicit:** Skill tells research.py which files to load
- **Implicit:** research.py auto-discovers based on query
- **Hybrid:** Skill pre-filters, research.py refines

---

### 2Ô∏è‚É£ Scope Inference (needs discussion)

**Question:** Can system infer scope from context?

**Scope definition:**
- **Currently:** Topic OR Book
- **Future:** Author, tags, date range

**Confidence threshold:**
- **Currently:** Unknown (not implemented)
- **Recommendation:** Start at **75%** (balance between interruptions vs errors)
  - Above 75% ‚Üí proceed with inference
  - Below 75% ‚Üí ask clarification
- **Logic:** Better to ask once than return wrong results

**Examples:**
- "pesquisa servitors" + previous conversation about chaos magick ‚Üí infer `--topics chaos-magick` (high confidence)
- "pesquisa economia" + no context ‚Üí ask "qual t√≥pico? finance? politics?" (low confidence)

---

### 3Ô∏è‚É£ Build Command (needs discussion)

**Current:**
```bash
cd ~/Documents/librarian && \
python3 engine/scripts/research.py "QUERY" --topics topic1,topic2
```

**Questions:**
- Should command building happen in **SKILL.md** (AI constructs it) or **shell wrapper** (deterministic)?
- Should we rename `research.py` ‚Üí `librarian.py`?
  - **Pro:** Matches system name
  - **Con:** "research" is the action users understand
  - **Alternative:** Keep `research.py` as entry point, `librarian.py` as orchestrator

**Decision needed:** Where does intelligence live? (AI vs shell script)

---

### 4Ô∏è‚É£ No Metadata = Hard Stop

**VISION.md principle:** Honesty > helpful lies.

**Current behavior:**
- Error message: "No metadata found. Run librarian index"
- **HARD STOP:** System does NOT attempt to answer without metadata

**Why:**
- Librarian = separate familiar/servitor
- If librarian can't fetch (no metadata) ‚Üí be honest, don't invent
- "N√£o achei" = honest
- "N√£o achei mas vou responder de outros pontos" = dishonest (user asked librarian)

**Philosophy:**
- Better to say "I don't have access" than give generic answer when user asked for books

---

### 5Ô∏è‚É£ Format Output (needs clarification)

**Question:** What does format output do TODAY (without future enhancements)?

**Known:**
- Markdown with citations (YES)
- Intelligence location TBD (skill? sh? py?)

**Unknown (future epics):**
- Kavita deep-links (paragraph/page precision) ‚Üí v1.4.0 "Reader Integration & Source Granularity"?
- Context snippets ‚Üí Same epic or separate?

**Decision needed:** Describe current minimal output format so I can execute.

---

## üéØ Objective

**Document what we want from librarian based on what we have.**

Adapt:
- **Prompt** (SKILL.md)
- **Shell wrapper** (.sh)
- **Python script** (.py)

---

## ‚úÖ Success Metric

**Skill = Deterministic protocol**

- Trigger ‚Üí follows ENTIRE protocol
- AI helps with:
  - Interpretation (from books)
  - Output (formatting, citations)
- Deterministic (same query = same behavior)

---

## Current State (Before)

**SKILL.md is overloaded:**
- Protocol logic mixed with usage instructions
- Hard to separate "how Claw uses it" from "how it works internally"
- Maintenance burden (update both places when things change)

---

## Goal (After)

Move intelligence to project, keep skill minimal.

---

## üé® Arch: Diagram Color System

**Visual language for diagram evolution:**

### Color Meanings

**Grey (`#E0E0E0`):** Building diagram
- Node exists but not yet discussed
- Structure only, no decisions made

**Pink (`#FFB6C1`, black text):** Needs discussion
- All nodes with emoji numbers (1Ô∏è‚É£, 2Ô∏è‚É£, 3Ô∏è‚É£)
- Questions to answer before proceeding
- Marks decision points

**Yellow (`#FFEB3B`, black text):** Approved
- Discussed and decided
- Ready for implementation
- Cleared for execution

**Blue (`#2196F3`, white text):** Executed
- Code matches diagram
- Map = territory
- Documentation of reality

### State Transitions

```
Grey ‚Üí Pink: Add notes/questions (needs discussion)
Grey ‚Üí Yellow: No questions, approved as-is
Pink ‚Üí Yellow: Questions answered, approved
Yellow ‚Üí Blue: Code implemented

All Yellow = Ready to execute (I can run without Nicholas)
All Blue = Complete (diagram = documentation)
```

### Philosophy

**Important:** Ask ALL questions (technical + architecture) so Nicholas can get out of the way and I run safely without input.

**Goal:** Maximum parity between map (diagram) and territory (code).

---

**Status:** Grey flow started. Pink nodes = open questions.
