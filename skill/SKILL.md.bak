---
name: librarian
description: "Research books via semantic search + reranking. ZERO TOLERANCE for inventionâ€”only cite what research.py returns. Triggers: 'pesquisa X no livro Y', 'procura Z nos livros', 'tarot book research'. Returns citations + snippets in librarian format. Requires: ~/Documents/librarian/ project (research.py, vector DB, EPUB collection)."
type: public
version: 1.0.0
status: stable
dependencies:
  - https://github.com/yourusername/librarian
  - python3
  - faiss
  - sentence-transformers
author: nonlinear
license: MIT
---

# ğŸ”´ LIBRARIAN SKILL â€” MANDATORY PROTOCOL

**âš ï¸ READ THIS ENTIRE FILE BEFORE RESPONDING TO ANY RESEARCH QUERY âš ï¸**

---

## ğŸš¨ STOP AND CHECK (MANDATORY CHECKLIST)

**Before responding to ANY research/book query, verify:**

- [ ] **Did I READ this entire SKILL.md file?** (If NO â†’ READ IT NOW)
- [ ] **Am I about to run `research.py` with EXACT syntax?** (If NO â†’ FIX IT)
- [ ] **Will I cite ONLY what comes from the JSON output?** (If NO â†’ DON'T RESPOND)

**If ANY box is unchecked â†’ STOP. Do not respond. Read this file first.**

---

## ğŸ”´ ZERO TOLERANCE POLICY

**This skill has ZERO TOLERANCE for:**
- âŒ Answering research questions without running `research.py`
- âŒ Using "general knowledge" instead of book citations
- âŒ Wrong syntax (results in garbage output)
- âŒ Inventing facts not present in JSON results
- âŒ Paraphrasing when you should quote directly

**Violation = Loss of trust. Nicholas depends on precision here.**

---

## Purpose

Semantic search across Nicholas's book library (EPUBs, PDFs).

**Location:** `~/Documents/librarian/`

---

## ğŸ”´ CRITICAL: Sintaxe = Protocolo (NÃƒO FUNCIONA SEM)

**Librarian NÃƒO Ã© chat. Ã‰ protocolo. Sintaxe errada = resultado invÃ¡lido.**

### **âŒ WRONG (nÃ£o funciona):**
```bash
python3 research.py "What is chaos magick?"
```

### **âœ… CORRECT (Ãºnico jeito):**
```bash
python3 engine/scripts/research.py "QUERY TEXT" --topics topic1,topic2
```

**Componentes obrigatÃ³rios:**
1. **`engine/scripts/research.py`** (caminho completo do script)
2. **`"QUERY TEXT"`** (aspas sempre)
3. **`--topics topic1,topic2`** (vÃ­rgulas sem espaÃ§os)

**Se vocÃª rodar sintaxe errada, output serÃ¡ garbage. Nicholas perde confianÃ§a.**

---

## Research Syntax (LOCAL ONLY)

**Librarian roda APENAS no MacBook** (`~/Documents/librarian/`). NÃ£o tÃ¡ no NAS.

```bash
cd ~/Documents/librarian && \
python3 engine/scripts/research.py "EXACT QUERY" --topics topic1,topic2
```

**Parameters:**
- **`"QUERY"`** - Exact search query (always quoted)
  - **Underscores OK** - queries like "self_metaprogramming" work fine
  - Any characters allowed (quotes protect special chars)
- **`--topics`** - Comma-separated topics (NO SPACES: `chaos-magick,occult`)
- **`--top-k N`** - Limit results (default: 10)
- **`--context-window N`** - Context chunks around match (default: 1)

**Output:**
- **JSON** with `results` array:
  ```json
  {
    "results": [
      {
        "title": "Book Title",
        "source_file": "path/to/file.epub",
        "text": "...matched text with context...",
        "score": 0.XX
      }
    ]
  }
  ```

**If no results:** `{"results": []}`

---

## Available Topics

**To see all topics:**
```bash
cd ~/Documents/librarian && ls -1 books/
```

**Common topics:**
- `chaos-magick`, `occult`, `witchcraft`, `tarot`
- `anarchism`, `politics`, `philosophy`
- `finance`, `business`, `economics`
- `sci-fi`, `fiction`, `short-stories`
- `tech`, `programming`, `systems`
- `rpg_mage` (Mage: The Ascension books)
- `magick/self-metaprogramming` (RAW, NLP, chaos magick)

**âš ï¸ Topic IDs use underscores, not slashes!**
- Folder: `books/RPG/Mage/` â†’ Topic ID: `rpg_mage`
- Folder: `books/magick/self-metaprogramming/` â†’ Topic ID: `magick/self-metaprogramming`

**Check `.topic-index.json` inside folder to get exact `topic_id`.**

---

## Index Structure (CRITICAL UNDERSTANDING)

**Librarian uses 3-level indexing:**

1. **`books/.library-index.json`** (root level)
   - List of ALL topics with paths
   - Schema: `{ "topics": [ {"id": "topic_id", "path": "relative/path"} ] }`

2. **`books/TOPIC/.topic-index.json`** (per-topic level)
   - Metadata for books in that topic
   - Lists files, titles, authors, tags
   - **`chunks_file` field** â†’ points to processed chunks (or null if not indexed)

3. **`index/`** directory (embeddings/chunks)
   - Actual text chunks + embeddings for semantic search
   - Created ONLY after running `index_library.py`

**ğŸš¨ COMMON MISTAKE:**
- `.library-index.json` + `.topic-index.json` can exist WITHOUT chunks
- This means **books are LISTED but NOT SEARCHABLE**
- Check `chunks_file` field in `.topic-index.json` to verify indexing

**To verify a topic is FULLY indexed:**
```bash
cd ~/Documents/librarian/books/TOPIC && \
cat .topic-index.json | jq -r '.books[0].chunks_file // "NOT_INDEXED"'
```

If output is `"NOT_INDEXED"` â†’ books are listed but chunks were never processed!

---

## Indexing (Maintenance)

**ğŸ”´ CRITICAL: Use Python 3.11 for indexing (3.14 freezes on model loading)**

**Reindex after adding books:**
```bash
cd ~/Documents/librarian && \
/opt/homebrew/bin/python3.11 engine/scripts/index_library.py
```

**NO FLAGS NEEDED:** Script auto-detects new topics and indexes them.

**Reindex specific topic (force rebuild):**
```bash
cd ~/Documents/librarian && \
/opt/homebrew/bin/python3.11 engine/scripts/index_library.py --topic TOPIC_ID --force
```

**Full rebuild (if needed):**
```bash
/opt/homebrew/bin/python3.11 engine/scripts/index_library.py --force
```

**âš ï¸ Common mistake:** Don't use `--topics AI` (it auto-discovers subtopics like AI/theory, AI/policy, etc.)

---

## Response Format (When Presenting Results)

**MANDATORY TEMPLATE (EXIGIDO):**
```markdown
**ğŸ“š RESEARCH: {topic}**

Achei **N resultados** de M livros.

---

1ï¸âƒ£ **{Result Title}**  
**Fonte:** *{Book Title}*, {metadata if available}

> {quoted_text_from_result}

---

2ï¸âƒ£ **{Next Result}**  
**Fonte:** *{Book Title 2}*

> {quoted_text_from_result_2}

---

**Fontes citadas:**
- *Book Title 1* (Author, Year)
- *Book Title 2* (Author, Year)
```

**Rules:**
- **MUST use 1ï¸âƒ£ 2ï¸âƒ£ 3ï¸âƒ£ format** (nÃ£o negociÃ¡vel)
- **Cite sources SEMPRE** (livro + autor se disponÃ­vel)
- **Quote literal text** (nÃ£o parafraseie)
- **Include score** se relevante (baixo score = avisa)
- **Se nÃ£o achar:** "NÃ£o achei resultados. Tente outros topics ou rephrasing."

---

## ğŸš¨ BEFORE YOU RESPOND

**Every time you prepare a librarian response, ask yourself:**

1. **Did I run `research.py` with exact syntax?** (YES/NO)
2. **Did I receive valid JSON output?** (YES/NO)
3. **Am I citing ONLY from that JSON?** (YES/NO)
4. **Did I verify the topic is indexed?** (check `chunks_file` in `.topic-index.json`)

**If any answer is NO â†’ STOP. Go back. Run the tool correctly.**

**"I think I know the answer" â‰  "I checked the books."**

**Nicholas asked for research. Give research, not guesses.**

**ğŸ”´ HALLUCINATION CHECK:**
- If you find yourself writing citations WITHOUT having run `research.py` â†’ **STOP IMMEDIATELY**
- If JSON output was empty but you're "remembering" content â†’ **THAT'S INVENTION, NOT RESEARCH**
- Better to say "nÃ£o achei" than fabricate sources

---

## ğŸš¨ ZERO TOLERANCE: No Invention

**If research.py doesn't run OR returns garbage:**
1. **STOP immediately**
2. **Say:** "Sintaxe errada, vou refazer"
3. **Read this SKILL.md again**
4. **Run with EXACT syntax**

**NEVER improvise answers if research failed. Librarian = facts from books, not LLM guesses.**

---

## Example Session

**User:** "Pesquisa sobre servitors em chaos magick"

**You:**
```bash
cd ~/Documents/librarian && \
python3 engine/scripts/research.py "How to create and program servitors in chaos magick" --topics chaos-magick,occult
```

**Output (JSON):**
```json
{
  "results": [
    {
      "title": "Servitor creation",
      "source_file": "books/chaos-magick/condensed-chaos.epub",
      "text": "A servitor is a semi-autonomous entity created...",
      "score": 0.89
    }
  ]
}
```

**You respond:**
> **ğŸ“š RESEARCH: Servitors**
> 
> Achei **1 resultado**.
> 
> **Fonte:** *Condensed Chaos* (Phil Hine)
> 
> > "A servitor is a semi-autonomous entity created for a specific purpose..."
>
> **Fontes citadas:**
> - *Condensed Chaos* by Phil Hine

---

## Metadata & Book Links

**Kavita integration:** Some books have `kavita_url` metadata.

**Example:**
```json
{
  "kavita_url": "http://192.168.1.152:5000/library/1/series/42"
}
```

**When presenting:** Include link if available:
> **ğŸ“– Read in Kavita:** [Open book](http://192.168.1.152:5000/library/1/series/42)

**No link?** Just cite book title.

---

## Troubleshooting

**Error: "No module named 'sentence_transformers'"**
- Embedding model missing. Run `pip install sentence-transformers`.

**Error: "FAISS index not found"**
- Index missing. Run `index_library.py --smart`.

**Empty results but you expected matches:**
- Check topic name (exact folder name)
- Try broader query
- Check if book is indexed (`ls books/{topic}/`)

**Underscores or special characters in queries:**
- âœ… **Always works in `research.py`** (quotes protect everything)
- âš ï¸ If using SSH wrapper (`research-tracked.sh`), underscores are handled
- **Fixed 2026-02-05:** jq parsing now handles underscores correctly

---

## Design Philosophy

**Librarian is ZERO TOLERANCE for invention.**

- **Bad research > invented facts.** Always better to say "nÃ£o achei" than guess.
- **Sintaxe = parte do protocolo.** If syntax wrong, output is garbage.
- **Citation is mandatory.** Every fact needs a source.

**This is Nicholas's research tool. Precision > speed.*
